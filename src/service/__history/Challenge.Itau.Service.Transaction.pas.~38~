unit Challenge.Itau.Service.Transaction;

interface

uses
  System.SysUtils,
  System.JSON,
  System.DateUtils,
  System.Generics.Collections,
  Challenge.Itau.Model.Transaction,
  Challenge.Itau.Model.TransactionList,
  Challenge.Itau.Model.Exceptions;

type
  TChallengeItauServiceTransaction = class
  private
    function ParseJSONToDouble(AKey: string; AValue: TJSONObject): Double;
    function ParseJSONToString(AKey: string; AValue: TJSONObject): string;

    procedure InsertTransaction(ATransaction: TJSONObject);
    procedure JSONSchemaValidate(AValue: TJSONObject);
  public
    procedure Insert(ATransaction: TJSONObject);
    procedure Delete;

    function Statistics: TJSONObject;
  end;

const
  cVALOR = 'valor';
  cDATA_HORA = 'dataHora';
  cBODY_KEYS: array[1..2] of string = (cVALOR, cDATA_HORA);

implementation

{ TChallengeItauServiceTransaction }

procedure TChallengeItauServiceTransaction.Delete;
begin
  TChallengeItauModelTransactionList.List.Clear;
end;

procedure TChallengeItauServiceTransaction.Insert(ATransaction: TJSONObject);
begin
  if not Assigned(ATransaction) then
    raise EJSONValidationError.Create('JSON inválido');

  JSONSchemaValidate(ATransaction);
  InsertTransaction(ATransaction);
end;

procedure TChallengeItauServiceTransaction.InsertTransaction(ATransaction: TJSONObject);
var
  LTransaction: TChallengeItauModelTransaction;
begin
  LTransaction := TChallengeItauModelTransaction.Create;
  LTransaction.Value := ParseJSONToDouble(cVALOR, ATransaction);
  LTransaction.SetDate(ParseJSONToString(cDATA_HORA, ATransaction));
  TChallengeItauModelTransactionList.List.Add(LTransaction);
end;

procedure TChallengeItauServiceTransaction.JSONSchemaValidate(AValue: TJSONObject);
var
  LEnumerator: TJSONPairEnumerator;
  I: Integer;
begin
  LEnumerator := AValue.GetEnumerator;
  while LEnumerator.MoveNext do
    for I := Low(cBODY_KEYS) to High(cBODY_KEYS) do
      if (AValue.GetValue(cBODY_KEYS[I]) = nil) then
        raise EValidationError.Create('Body formatting error: ' + cBODY_KEYS[I] + ' é obrigatório');
end;

function TChallengeItauServiceTransaction.ParseJSONToString(AKey: string; AValue: TJSONObject): string;
var
  LJSONValue: TJSONValue;
begin
  Result := EmptyStr;
  if AValue.TryGetValue(AKey, LJSONValue) then
    Result := LJSONValue.ToString;
end;

function TChallengeItauServiceTransaction.Statistics: TJSONObject;
var
  LTransaction: TChallengeItauModelTransaction;
begin
  Result := TJSONObject.Create;
  Result
    .AddPair('count', TJSONNumber.Create(0))
    .AddPair('sum', TJSONNumber.Create(0))
    .AddPair('avg', TJSONNumber.Create(0))
    .AddPair('min', TJSONNumber.Create(0))
    .AddPair('max', TJSONNumber.Create(0));

  for LTransaction in TChallengeItauModelTransactionList.List do
    if MinuteOf(LTransaction.GetDate) <= MinuteOf(Now) then
    begin
      Result.TryGetValue('count')
    end;
end;

function TChallengeItauServiceTransaction.ParseJSONToDouble(AKey: string; AValue: TJSONObject): Double;
var
  LJSONValue: TJSONValue;
begin
  Result := 0;
  if AValue.TryGetValue(AKey, LJSONValue) then
    if LJSONValue is TJSONNumber then
      Result := TJSONNumber(LJSONValue).AsDouble;
end;

end.
